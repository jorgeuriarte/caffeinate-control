name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# Permisos necesarios para crear releases
permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: ğŸ”¨ Build application
      run: |
        chmod +x build.sh
        CI=true ./build.sh ${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ“¦ Create professional installer
      run: |
        chmod +x claude_tools/build-professional-installer.sh
        ./claude_tools/build-professional-installer.sh ${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ“‹ Verify installer created
      run: |
        ls -lh build/
        test -f "build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg"
        test -f "build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg.sha256"
        echo "âœ… Professional installer created successfully"
        
    - name: ğŸ§ª Test application
      run: |
        # Verificar que la app se creÃ³ correctamente
        test -d "build/CaffeinateControl.app"
        test -f "build/CaffeinateControl.app/Contents/MacOS/CaffeinateControl"
        test -f "build/CaffeinateControl.app/Contents/Info.plist"
        echo "âœ… Application structure verified"
        
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CaffeinateControl-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg
          build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg.sha256
          build/CaffeinateControl.app
        retention-days: 30

  release:
    needs: build
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
    - name: ğŸ”¨ Build application for release
      run: |
        chmod +x build.sh
        CI=true ./build.sh ${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ“¦ Create professional installer for release
      run: |
        chmod +x claude_tools/build-professional-installer.sh
        ./claude_tools/build-professional-installer.sh ${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ“‹ Generate release notes
      id: release_notes
      run: |
        cat << 'EOF' > release_notes.md
        ## ğŸ‰ CaffeinateControl v${{ steps.get_version.outputs.VERSION }}

        ### ğŸ†• Nuevas caracterÃ­sticas
        - âœ… Bugs de pmset corregidos - la pantalla ahora se apaga correctamente
        - âœ… Helper script para operaciÃ³n sin contraseÃ±a
        - âœ… Herramientas de diagnÃ³stico y reset incluidas
        - âœ… Instalador profesional completamente automatizado

        ### ğŸ“¥ InstalaciÃ³n (Super fÃ¡cil)

        **OpciÃ³n 1: Instalador Profesional (RECOMENDADO) â­**
        1. Descarga `CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg`
        2. Doble click en el archivo
        3. Sigue el instalador (siguiente â†’ siguiente â†’ instalar)
        4. Ingresa contraseÃ±a si es solicitado
        5. Â¡Listo! La app estÃ¡ en /Applications

        **Eso es todo. No necesitas:**
        - âŒ Arrastrar carpetas
        - âŒ Abrir terminal
        - âŒ Ejecutar scripts
        - âŒ Conocimiento tÃ©cnico

        ### âœ¨ CaracterÃ­sticas
        - ğŸ¯ Control visual de caffeinate desde la barra de estado
        - â° MÃºltiples duraciones: 15min, 30min, 1h, 2h
        - ğŸ”§ ConfiguraciÃ³n avanzada de flags de caffeinate
        - ğŸ”” Sistema de alarmas personalizables
        - ğŸ’¾ Persistencia de configuraciÃ³n
        - ğŸŒ™ PrevenciÃ³n de suspensiÃ³n con tapa cerrada
        - ğŸ” Helper script automÃ¡tico para operaciÃ³n sin contraseÃ±a

        ### ğŸ”§ Requisitos del Sistema
        - macOS 10.15 (Catalina) o superior
        - Arquitectura Intel x64 o Apple Silicon

        ### ğŸ“– DocumentaciÃ³n
        - INSTALLATION.md - GuÃ­a completa
        - DISTRIBUTION.md - InformaciÃ³n tÃ©cnica
        - PRIVILEGIOS.md - Detalles de privilegios

        ### ğŸ” Checksums SHA256

        Verifica la integridad de tu descarga:
        \`\`\`
        $(cat build/*-Installer.pkg.sha256)
        \`\`\`

        Usa: \`shasum -a 256 -c filename.sha256\`

        ### ğŸ› Problemas Conocidos
        Si macOS muestra advertencias de seguridad, ve a \`Preferencias del Sistema > Seguridad y Privacidad\` y permite la ejecuciÃ³n de la aplicaciÃ³n.

        ---

        **Â¡Disfruta CaffeinateControl!** â˜•ï¸
        EOF

    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "CaffeinateControl v${{ steps.get_version.outputs.VERSION }}"
        body_path: release_notes.md
        files: |
          build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg
          build/CaffeinateControl-${{ steps.get_version.outputs.VERSION }}-Installer.pkg.sha256
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}